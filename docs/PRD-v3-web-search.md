# MyClaw — 互联网搜索能力 产品需求文档 (PRD)

> 版本：v3.0  
> 日期：2026-02-23  
> 状态：已实现  
> 基于：PRD-v2（可视化 + Skill 体系）

---

## 1. 背景与动机

### 1.1 现状

MyClaw Agent 在 v2 版本中已具备文件读写、网页抓取（`web_fetch`）、Python/Shell 执行、Skill 渐进式披露等完整能力。但 Agent **缺少主动搜索互联网的能力** — `web_fetch` 只能抓取已知 URL 的内容，无法在用户不提供链接的情况下主动查找信息。

### 1.2 核心问题

| 问题 | 影响 |
|------|------|
| 无法回答实时性问题（新闻、时事、最新版本等） | 用户体验差，Agent 只能依赖模型训练数据 |
| 用户必须自行提供 URL 才能让 Agent 阅读网页 | 交互繁琐，不符合"通用助手"定位 |
| 模型对未知信息可能产生幻觉 | 回答准确性无法保证 |

### 1.3 目标

为 Agent 增加 **互联网搜索** 内置工具，使其能够：
1. 根据用户问题自主决定是否需要搜索
2. 获取结构化搜索结果（标题、URL、摘要）
3. 结合 `web_fetch` 对搜索结果进行深度阅读
4. 基于真实信息源给出有据可查的回答

---

## 2. 方案选型

### 2.1 评估维度

| 维度 | 权重 | 说明 |
|------|------|------|
| 每月免费额度（循环） | 高 | 开发阶段不希望产生费用 |
| 中国大陆可用 | 高 | 服务部署在大陆 |
| 全球搜索能力 | 高 | 不局限于单一搜索引擎生态 |
| 结构化返回 | 高 | 需返回 URL + 标题 + 摘要，供 Agent 后续 action |
| LangChain 生态 | 中 | 有官方集成更好，但非必须 |

### 2.2 候选方案对比

| 服务 | 免费额度 | 中国可用 | 全球搜索 | 结构化返回 | 选用 |
|------|---------|---------|---------|-----------|------|
| **Tavily** | 1,000次/月（每月重置） | 是 | 是 | URL + 标题 + 摘要 + 评分 | **选用** |
| Bing Search API | 1,000次/月 | 不确定（依赖 Azure） | 是 | URL + 标题 + 摘要 | — |
| 博查 Bocha | 1,000次（一次性） | 是 | 偏国内 | URL + 标题 + 摘要 | — |
| SerpAPI | 250次/月 | 不确定 | 是 | URL + 标题 + 摘要 | — |
| DashScope enable_search | 按模型 token 计费 | 是 | 不透明 | 不返回给 Agent | — |

### 2.3 最终选择

**Tavily Search API（REST 方式直接调用）**

- 免费套餐 1,000 次/月，每月 1 号自动重置
- 中国大陆已确认可用（腾讯云、Dify 等平台已集成）
- 无需绑定信用卡
- 不使用 LangChain 内置的 `TavilySearchResults`，自行用 `httpx` 调用 REST API，与项目现有工具风格一致

---

## 3. 功能需求

### 3.1 web_search 内置工具（F-WS-01）

**描述**：新增 `web_search` 内置工具，Agent 可通过 function calling 直接调用。

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| F-WS-01-01 | 工具接受 `query`（搜索关键词）和 `max_results`（最大结果数，默认 5）两个参数 | P0 | 已实现 |
| F-WS-01-02 | 调用 Tavily Search API（`POST https://api.tavily.com/search`） | P0 | 已实现 |
| F-WS-01-03 | 返回格式化的搜索结果列表，每条包含：序号、标题、URL、摘要、相关度评分 | P0 | 已实现 |
| F-WS-01-04 | API Key 从环境变量 `TAVILY_API_KEY` 动态读取（每次调用时读取，非模块级） | P0 | 已实现 |
| F-WS-01-05 | 完善的错误处理：超时、401（Key 无效）、429（频率限制）、432（额度用完） | P1 | 已实现 |
| F-WS-01-06 | 最大结果数上限为 10，防止单次消耗过多 token | P1 | 已实现 |

### 3.2 系统提示词优化（F-WS-02）

**描述**：重构 system prompt，从"规则列表"升级为"能力描述 + 核心原则"，引导 Agent 更智能地使用工具组合。

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| F-WS-02-01 | 工具按功能分组（信息获取 / 内容生成 / Skill 管理），每个工具附带签名和简要说明 | P0 | 已实现 |
| F-WS-02-02 | 明确 `web_search` 返回的是摘要片段，不足以支撑深度分析 | P0 | 已实现 |
| F-WS-02-03 | "信息充分性"原则：引导 Agent 在信息不足时主动追加工具调用（而非编造数据） | P0 | 已实现 |
| F-WS-02-04 | "聚焦当前问题"原则明确：追问/深入请求视为新需求，可能需要新的工具调用 | P0 | 已实现 |
| F-WS-02-05 | 不硬编码工作流（如"搜索后必须 fetch"），让 Agent 根据任务复杂度自主判断 | P0 | 已实现 |

### 3.3 配置管理（F-WS-03）

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| F-WS-03-01 | `TAVILY_API_KEY` 配置在 `backend/.env` 中 | P0 | 已实现 |
| F-WS-03-02 | `web_search` 注册到 `BUILTIN_TOOLS` 列表 | P0 | 已实现 |

---

## 4. 技术实现

### 4.1 架构

```
用户提问
  ↓
LLM 判断是否需要搜索
  ↓ (function calling)
web_search(query) ──→ Tavily REST API ──→ 结构化结果
  ↓
LLM 评估信息充分性
  ├── 充分 → 直接回答
  └── 不足 → web_fetch(url) → 获取全文 → 综合分析后回答
```

### 4.2 文件变更

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `backend/tools/web_search.py` | 新增 | Tavily 搜索工具实现 |
| `backend/tools/__init__.py` | 修改 | 注册 `web_search` 到 `BUILTIN_TOOLS` |
| `backend/.env` | 修改 | 新增 `TAVILY_API_KEY` 配置项 |
| `backend/prompts/system.md` | 重构 | 工具描述分组 + 核心原则升级 |

### 4.3 关键实现细节

**环境变量加载时序**：`TAVILY_API_KEY` 必须在函数内部通过 `os.getenv()` 动态读取，不能在模块级别读取。因为 `main.py` 中 `from api.routes import router` 的导入发生在 `load_dotenv()` 之前，模块级读取会得到空字符串。

### 4.4 API 调用规格

- **Endpoint**：`POST https://api.tavily.com/search`
- **认证**：`Authorization: Bearer {TAVILY_API_KEY}`
- **请求体**：

```json
{
  "query": "搜索关键词",
  "search_depth": "basic",
  "max_results": 5,
  "include_answer": false,
  "include_raw_content": false
}
```

- **响应结构**（关键字段）：

```json
{
  "results": [
    {
      "title": "页面标题",
      "url": "https://...",
      "content": "摘要文本",
      "score": 0.95
    }
  ]
}
```

- **消耗**：`basic` 深度 = 1 credit/次；`advanced` = 2 credits/次
- **免费额度**：1,000 credits/月，每月 1 号重置

---

## 5. Agent 搜索行为预期

### 5.1 场景矩阵

| 场景类型 | 预期行为 | 工具调用链 |
|---------|---------|-----------|
| 简单事实查询（"Python 最新版本是什么"） | 搜索后直接基于摘要回答 | `web_search` → 回答 |
| 概览浏览（"最近有什么 AI 新闻"） | 搜索后汇总摘要列表 | `web_search` → 回答 |
| 深度分析（"详细分析 X 的原因"） | 搜索 → 读取原文 → 分析 | `web_search` → `web_fetch` × N → 回答 |
| 追问深入（基于上轮结果追问细节） | 识别为新需求，追加搜索或阅读原文 | `web_search` / `web_fetch` → 回答 |
| 已知 URL（"帮我看下这个链接"） | 直接抓取，无需搜索 | `web_fetch` → 回答 |
| 纯本地任务（"读取文件 / 执行代码"） | 不触发搜索 | `read_file` / `python_executor` → 回答 |

### 5.2 信息充分性判断

Agent 通过 system prompt 中的"信息充分性"原则自主判断，而非硬编码规则：

- 搜索摘要足够回答 → 直接回答（节省 token 和时间）
- 摘要不够，需要原文支撑 → 自动调用 `web_fetch`
- 需要更多视角 → 追加 `web_search` 换不同关键词

这一判断由 LLM 根据任务复杂度自行决策，system prompt 只提供原则性引导。

---

## 6. 验收标准

| ID | 验收项 | 通过条件 |
|----|--------|---------|
| AC-01 | 工具注册 | `/api/tools` 返回列表中包含 `web_search` |
| AC-02 | 基本搜索 | 发送"搜索 LangChain 最新版本"，Agent 调用 `web_search` 并返回带 URL 的结果 |
| AC-03 | 深度分析 | 发送需要深入分析的问题，Agent 在搜索后主动调用 `web_fetch` 获取原文 |
| AC-04 | 追问场景 | 首轮搜索后追问"详细分析原因"，Agent 追加搜索或 fetch，而非纯凭已有信息回答 |
| AC-05 | 无需搜索的任务 | 发送"用 Python 计算 1+1"，Agent 不调用搜索相关工具 |
| AC-06 | 错误处理 | 使用无效 API Key 时，返回友好的错误提示 |
| AC-07 | Graph 可视化 | 搜索工具调用在右侧执行图中正确显示为 tool 节点 |
| AC-08 | 对话记录 | 搜索相关的工具调用和结果正确保存在会话 Markdown 文件中 |

---

## 7. 后续演进方向

| 方向 | 说明 | 优先级 |
|------|------|--------|
| 搜索结果缓存 | 相同 query 短时间内命中缓存，节省 API 调用次数 | P2 |
| 多搜索引擎后备 | Tavily 不可用时自动切换到备用搜索服务 | P3 |
| 搜索历史面板 | 前端展示 Agent 的搜索历史记录，支持回溯 | P3 |
| 搜索 Skill 化 | 将 web_search 从内置工具迁移为可配置 Skill | P3 |
